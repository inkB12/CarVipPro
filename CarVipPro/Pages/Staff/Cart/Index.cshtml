@page
@model CarVipPro.APrenstationLayer.Pages.Staff.Cart.IndexModel
@using CarVipPro.APrenstationLayer.Infrastructure
@{
    ViewData["Title"] = "Giỏ hàng";
    var channel = CartChannel.EnsureChannel(HttpContext.Session);
}

<h2 class="mb-3">Giỏ hàng</h2>

@if (!string.IsNullOrEmpty(Model.Error))
{
    <div class="alert alert-danger">@Model.Error</div>
}
@if (!string.IsNullOrEmpty(Model.Info))
{
    <div class="alert alert-success">@Model.Info</div>
}

<div id="cart-container">
    @if (Model.Cart.Items.Count == 0)
    {
        <div class="alert alert-info">Giỏ hàng đang trống.</div>
        <a class="btn btn-outline-primary" asp-page="/Staff/Vehicles/Index">Tiếp tục chọn xe</a>
    }
    else
    {
        <table class="table align-middle" id="cart-table">
            <thead>
                <tr>
                    <th>Xe</th>
                    <th>Đơn giá</th>
                    <th style="width:160px">Số lượng</th>
                    <th>Tạm tính</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cart-body">
                @foreach (var it in Model.Cart.Items)
                {
                    <tr data-id="@it.ElectricVehicleId">
                        <td>
                            <div class="d-flex align-items-center">
                                @if (!string.IsNullOrEmpty(it.ImageUrl))
                                {
                                    <img src="@it.ImageUrl" alt="" style="width:60px;height:40px;object-fit:cover" class="me-2" onerror="this.style.display='none'" />
                                }
                                <div>
                                    <div class="fw-semibold">@it.Name</div>
                                    @if (!string.IsNullOrWhiteSpace(it.Color))
                                    {
                                        <div class="text-muted small">Màu: @it.Color</div>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>@it.UnitPrice.ToString("n0")</td>
                        <td>
                            <input class="form-control qty-input"
                                   type="number"
                                   min="1"
                                   value="@it.Quantity"
                                   data-id="@it.ElectricVehicleId" />
                        </td>
                        <td class="line-total fw-bold">@it.LineTotal.ToString("n0")</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger btn-remove" data-id="@it.ElectricVehicleId">Xóa</button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-semibold">Tổng:</td>
                    <td id="cart-total" class="fw-bold">@Model.Cart.Total.ToString("n0")</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    }
</div>

<hr />

<h5>Thanh toán</h5>
<div class="row g-3">
    <div class="col-md-3">
        <label class="form-label">Customer ID</label>
        <input class="form-control" name="CustomerId" value="@Model.CustomerId" />
    </div>
    <div class="col-md-3">
        <label class="form-label">Payment</label>
        <select class="form-select" name="PaymentMethod">
            <option value="CASH" selected="@(Model.PaymentMethod == "CASH")">CASH</option>
            <option value="MOMO" selected="@(Model.PaymentMethod == "MOMO")">MOMO</option>
            <option value="INSTALLMENT" selected="@(Model.PaymentMethod == "INSTALLMENT")">INSTALLMENT</option>
        </select>
    </div>
</div>

<div class="mt-3">
    <form method="post">
        <button class="btn btn-success" formaction="?handler=Checkout" formmethod="post">Thanh toán</button>
    </form>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const channel = '@channel';
        console.log("Current SignalR channel:", channel);
    </script>
    <script>
        (async function () {
            const channel = "@channel";
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/cartHub?channel=" + channel)
                .build();

            await connection.start();
            console.log("✅ SignalR connected to CartHub:", channel);

            document.addEventListener("change", async (e) => {
              if (e.target.classList.contains("qty-input")) {
                const id = parseInt(e.target.dataset.id);
                const qty = parseInt(e.target.value);
                if (qty > 0) {
                  await fetch("/Staff/Cart/Api?handler=Update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, qty })
                  });
                }
              }
            });

            document.addEventListener("click", async (e) => {
              if (e.target.classList.contains("btn-remove")) {
                const id = parseInt(e.target.dataset.id);
                await fetch("/Staff/Cart/Api?handler=Remove", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id })
                });
              }
            });

            connection.on("CartUpdated", async (data) => {
              if (typeof data === "number") {
                const res = await fetch("/Staff/Cart/Api?handler=Items");
                data = await res.json();
              }
              renderCart(data);
            });

            // Cập nhật lại giao diện
            function renderCart(data) {
                const tbody = document.getElementById("cart-body");
                tbody.innerHTML = "";

                if (!data.items || data.items.length === 0) {
                    document.getElementById("cart-container").innerHTML = `
                        <div class="alert alert-info">Giỏ hàng đang trống.</div>
                        <a class="btn btn-outline-primary" href="/Staff/Vehicles/Index">Tiếp tục chọn xe</a>
                    `;
                    return;
                }

                data.items.forEach(it => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${it.name}</td>
                        <td>${it.unitPrice.toLocaleString()}</td>
                        <td><input class="form-control qty-input" type="number" min="1" value="${it.quantity}" data-id="${it.electricVehicleId}"></td>
                        <td class="fw-bold">${it.lineTotal.toLocaleString()}</td>
                        <td class="text-end"><button class="btn btn-sm btn-outline-danger btn-remove" data-id="${it.electricVehicleId}">Xóa</button></td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById("cart-total").textContent = data.total.toLocaleString();
            }
        })();
    </script>
}
