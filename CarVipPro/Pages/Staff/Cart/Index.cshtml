@page
@model CarVipPro.APrenstationLayer.Pages.Staff.Cart.IndexModel
@using CarVipPro.APrenstationLayer.Infrastructure
@{
    ViewData["Title"] = "Giỏ hàng";
    Layout = "_Layout";
    var channel = CartChannel.EnsureChannel(HttpContext.Session);
}

<h2 class="mb-3">Giỏ hàng</h2>

@if (!string.IsNullOrEmpty(Model.Error))
{
    <div class="alert alert-danger">@Model.Error</div>
}
@if (!string.IsNullOrEmpty(Model.Info))
{
    <div class="alert alert-success">@Model.Info</div>
}

<div id="cart-container">
    @if (Model.Cart.Items.Count == 0)
    {
        <div class="alert alert-info">Giỏ hàng đang trống.</div>
        <a class="btn btn-outline-primary" asp-page="/Staff/Vehicles/Index">Tiếp tục chọn xe</a>
    }
    else
    {
        <table class="table align-middle" id="cart-table">
            <thead>
                <tr>
                    <th>Xe</th>
                    <th>Đơn giá</th>
                    <th style="width:160px">Số lượng</th>
                    <th>Tạm tính</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cart-body">
                @foreach (var it in Model.Cart.Items)
                {
                    <tr data-id="@it.ElectricVehicleId">
                        <td>
                            <div class="d-flex align-items-center">
                                @if (!string.IsNullOrEmpty(it.ImageUrl))
                                {
                                    <img src="@it.ImageUrl" alt="" style="width:60px;height:40px;object-fit:cover" class="me-2" onerror="this.style.display='none'" />
                                }
                                <div>
                                    <div class="fw-semibold">@it.Name</div>
                                    @if (!string.IsNullOrWhiteSpace(it.Color))
                                    {
                                        <div class="text-muted small">Màu: @it.Color</div>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>@it.UnitPrice.ToString("n0")</td>
                        <td>
                            <input class="form-control qty-input"
                                   type="number"
                                   min="1"
                                   value="@it.Quantity"
                                   data-id="@it.ElectricVehicleId" />
                        </td>
                        <td class="line-total fw-bold">@it.LineTotal.ToString("n0")</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger btn-remove" data-id="@it.ElectricVehicleId">Xóa</button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-semibold">Tổng:</td>
                    <td id="cart-total" class="fw-bold">@Model.Cart.Total.ToString("n0")</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    }
</div>
<hr />

<form method="post" asp-page-handler="Checkout" id="checkoutForm">
    <h5>Thanh toán</h5>
    <div class="row g-3">
        <div class="col-md-6 position-relative">
            <label class="form-label">Khách hàng</label>

            <!-- Hidden ID được submit -->
            <input type="hidden" name="CustomerId" id="customerId" value="@Model.CustomerId" />

            <!-- Ô tìm kiếm khách hàng -->
            <input type="text"
                   class="form-control"
                   id="customerSearch"
                   placeholder="Nhập tên / email / số điện thoại để tìm..."
                   autocomplete="off" />

            <!-- Hiển thị khách hàng đã chọn -->
            <div id="customerPicked" class="mt-2" style="display:none">
                <span class="badge bg-success me-2" id="customerPickedName"></span>
                <span class="text-muted small" id="customerPickedInfo"></span>
                <button type="button" class="btn btn-sm btn-link text-danger ms-2" id="clearPicked">Đổi khách</button>
            </div>

            <!-- Dropdown kết quả -->
            <div id="customerResults"
                 class="list-group position-absolute w-100"
                 style="z-index:1050; max-height:300px; overflow:auto; display:none"></div>
        </div>

        <div class="col-md-3">
            <label class="form-label">Payment</label>
            <select class="form-select" name="PaymentMethod">
                <option value="CASH" selected="@(Model.PaymentMethod == "CASH")">CASH</option>
                <option value="MOMO" selected="@(Model.PaymentMethod == "MOMO")">MOMO</option>
                <option value="INSTALLMENT" selected="@(Model.PaymentMethod == "INSTALLMENT")">INSTALLMENT</option>
            </select>
        </div>
    </div>

    
    <div class="mt-3 d-flex gap-2">

        <a class="btn btn-outline-primary" asp-page="/Staff/Cart/CreateCustomer">Tạo mới</a>
        <button class="btn btn-success" type="submit">Thanh toán</button>
        
    </div>
    
</form>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const channel = '@channel';
        console.log("Current SignalR channel:", channel);
    </script>

    <script>
        // ---------- Customer search ----------
        (function(){
            const searchBox = document.getElementById('customerSearch');
            const resultsBox = document.getElementById('customerResults');
            const pickedWrap = document.getElementById('customerPicked');
            const pickedName = document.getElementById('customerPickedName');
            const pickedInfo = document.getElementById('customerPickedInfo');
            const clearPicked = document.getElementById('clearPicked');
            const hiddenId = document.getElementById('customerId');

            let debounceTimer = null;

            function hideResults(){ resultsBox.style.display = 'none'; resultsBox.innerHTML = ''; }
            function showResults(){ resultsBox.style.display = 'block'; }

            async function search(q){
                if(!q || q.trim().length < 2){ hideResults(); return; }
                const url = `@Url.Page("/Staff/Cart/Index", null, new { handler = "CustomerSearch" })&q=` + encodeURIComponent(q);
                const res = await fetch(url, { method: 'GET' });
                if(!res.ok){ hideResults(); return; }
                const data = await res.json();
                renderResults(data);
            }

            function renderResults(list){
                resultsBox.innerHTML = '';
                if(!Array.isArray(list) || list.length === 0){ hideResults(); return; }

                list.forEach(c => {
                    const a = document.createElement('button');
                    a.type = 'button';
                    a.className = 'list-group-item list-group-item-action';
                    a.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <div><strong>${escapeHtml(c.fullName ?? '(No name)')}</strong></div>
                            <div class="text-muted small">#${c.id}</div>
                        </div>
                        <div class="small text-muted">${escapeHtml(c.email ?? '')} • ${escapeHtml(c.phone ?? '')}</div>
                    `;
                    a.addEventListener('click', () => pickCustomer(c));
                    resultsBox.appendChild(a);
                });
                showResults();
            }

            function pickCustomer(c){
                hiddenId.value = c.id;
                pickedName.textContent = c.fullName ?? '(No name)';
                pickedInfo.textContent = `${c.email ?? ''} • ${c.phone ?? ''}`;
                pickedWrap.style.display = '';
                searchBox.value = '';
                hideResults();
            }

            clearPicked.addEventListener('click', () => {
                hiddenId.value = '';
                pickedWrap.style.display = 'none';
            });

            searchBox.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => search(e.target.value), 250);
            });

            document.addEventListener('click', (e) => {
                if(!resultsBox.contains(e.target) && e.target !== searchBox){
                    hideResults();
                }
            });

            function escapeHtml(str){ return (str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
        })();
        // ---------- End Customer search ----------
    </script>

    <script>
        (async function () {
            const channel = "@channel";
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/cartHub?channel=" + channel)
                .build();

            await connection.start();
            console.log("✅ SignalR connected to CartHub:", channel);

            document.addEventListener("change", async (e) => {
              if (e.target.classList.contains("qty-input")) {
                const id = parseInt(e.target.dataset.id);
                const qty = parseInt(e.target.value);
                if (qty > 0) {
                  await fetch("/Staff/Cart/Api?handler=Update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, qty })
                  });
                }
              }
            });

            document.addEventListener("click", async (e) => {
              if (e.target.classList.contains("btn-remove")) {
                const id = parseInt(e.target.dataset.id);
                await fetch("/Staff/Cart/Api?handler=Remove", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id })
                });
              }
            });

            connection.on("CartUpdated", async (data) => {
              if (typeof data === "number") {
                const res = await fetch("/Staff/Cart/Api?handler=Items");
                data = await res.json();
              }
              renderCart(data);
            });

            // Cập nhật lại giao diện
            function renderCart(data){
              const container = document.getElementById('cart-container');
              if(!data.items || data.items.length===0){
                container.innerHTML = `
                  <div class="alert alert-info">Giỏ hàng đang trống.</div>
                  <a class="btn btn-outline-primary" href="/Staff/Vehicles/Index">Tiếp tục chọn xe</a>`;
                return;
              }
              const tbody   = document.getElementById('cart-body');
              const totalEl = document.getElementById('cart-total');
              const tpl     = document.getElementById('cart-row-tpl').content;

              tbody.innerHTML = '';
              data.items.forEach(it=>{
                const id        = it.id ?? it.electricVehicleId;
                const name      = it.name ?? it.model ?? '';
                const unit      = it.unitPrice ?? it.price ?? 0;
                const qty       = it.qty ?? it.quantity ?? 1;
                const line      = it.lineTotal ?? (unit * qty);
                const img       = it.imageUrl ?? '';
                const color     = it.color ?? '';

                const row = document.importNode(tpl, true);
                row.querySelector('tr').dataset.id = id;
                row.querySelector('.cart-name').textContent = name;
                const imgEl = row.querySelector('.cart-img');
                if(img){ imgEl.src = img; } else { imgEl.style.display='none'; }
                const colorWrap = row.querySelector('.cart-color');
                if(color){ colorWrap.style.display=''; colorWrap.querySelector('span').textContent = color; }

                row.querySelector('.cart-unit').textContent   = unit.toLocaleString('vi-VN');
                row.querySelector('.qty-input').value         = qty;
                row.querySelector('.qty-input').dataset.id    = id;
                row.querySelector('.line-total').textContent  = line.toLocaleString('vi-VN');
                row.querySelector('.btn-remove').dataset.id   = id;

                tbody.appendChild(row);
              });
              totalEl.textContent = (data.total ?? 0).toLocaleString('vi-VN');
            }

        })();
    </script>
}

<template id="cart-row-tpl">
    <tr data-id="">
        <td>
            <div class="d-flex align-items-center">
                <img class="me-2 cart-img" src="" alt=""
                     style="width:60px;height:40px;object-fit:cover" onerror="this.style.display='none'">
                <div>
                    <div class="fw-semibold cart-name"></div>
                    <div class="text-muted small cart-color" style="display:none">Màu: <span></span></div>
                </div>
            </div>
        </td>
        <td class="cart-unit"></td>
        <td>
            <input class="form-control qty-input" type="number" min="1" value="" data-id="">
        </td>
        <td class="line-total fw-bold"></td>
        <td class="text-end">
            <button class="btn btn-sm btn-outline-danger btn-remove" data-id="">Xóa</button>
        </td>
    </tr>
</template>
