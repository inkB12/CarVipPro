@page
@model CarVipPro.APrenstationLayer.Pages.Staff.Cart.IndexModel
@using CarVipPro.APrenstationLayer.Infrastructure
@{
    ViewData["Title"] = "Giỏ hàng";
    Layout = "_Layout";
    var channel = CartChannel.EnsureChannel(HttpContext.Session);
}

<h2 class="mb-3">Giỏ hàng</h2>

@if (!string.IsNullOrEmpty(Model.Error))
{
    <div class="alert alert-danger">@Model.Error</div>
}
@if (!string.IsNullOrEmpty(Model.Info))
{
    <div class="alert alert-success">@Model.Info</div>
}

<div id="cart-container">
    @if (Model.Cart.Items.Count == 0)
    {
        <div class="alert alert-info">Giỏ hàng đang trống.</div>
        <a class="btn btn-outline-primary" asp-page="/Staff/Vehicles/Index">Tiếp tục chọn xe</a>
    }
    else
    {
        <table class="table align-middle" id="cart-table">
            <thead>
                <tr>
                    <th>Xe</th>
                    <th>Đơn giá</th>
                    <th style="width:160px">Số lượng</th>
                    <th>Tạm tính</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cart-body">
                @foreach (var it in Model.Cart.Items)
                {
                    <tr data-id="@it.ElectricVehicleId">
                        <td>
                            <div class="d-flex align-items-center">
                                @if (!string.IsNullOrEmpty(it.ImageUrl))
                                {
                                    <img src="@it.ImageUrl" alt="" style="width:60px;height:40px;object-fit:cover" class="me-2" onerror="this.style.display='none'" />
                                }
                                <div>
                                    <div class="fw-semibold">@it.Name</div>
                                    @if (!string.IsNullOrWhiteSpace(it.Color))
                                    {
                                        <div class="text-muted small">Màu: @it.Color</div>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>@it.UnitPrice.ToString("n0")</td>
                        <td>
                            <input class="form-control qty-input"
                                   type="number"
                                   min="1"
                                   value="@it.Quantity"
                                   data-id="@it.ElectricVehicleId" />
                        </td>
                        <td class="line-total fw-bold">@it.LineTotal.ToString("n0")</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger btn-remove" data-id="@it.ElectricVehicleId">Xóa</button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-semibold">Tổng:</td>
                    <td id="cart-total" class="fw-bold">@Model.Cart.Total.ToString("n0")</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    }
</div>
<hr />

<form method="post" asp-page-handler="Checkout" id="checkoutForm">
    <h5>Thanh toán</h5>
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Customer ID</label>
            <input class="form-control" name="CustomerId" value="@Model.CustomerId" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Payment</label>
            <select class="form-select" name="PaymentMethod">
                <option value="CASH" selected="@(Model.PaymentMethod == "CASH")">CASH</option>
                <option value="MOMO" selected="@(Model.PaymentMethod == "MOMO")">MOMO</option>
                <option value="INSTALLMENT" selected="@(Model.PaymentMethod == "INSTALLMENT")">INSTALLMENT</option>
            </select>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-success" type="submit">Thanh toán</button>
    </div>
</form>


@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const channel = '@channel';
        console.log("Current SignalR channel:", channel);
    </script>
    <script>
        (async function () {
            const channel = "@channel";
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/cartHub?channel=" + channel)
                .build();

            await connection.start();
            console.log("✅ SignalR connected to CartHub:", channel);

            document.addEventListener("change", async (e) => {
              if (e.target.classList.contains("qty-input")) {
                const id = parseInt(e.target.dataset.id);
                const qty = parseInt(e.target.value);
                if (qty > 0) {
                  await fetch("/Staff/Cart/Api?handler=Update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, qty })
                  });
                }
              }
            });

            document.addEventListener("click", async (e) => {
              if (e.target.classList.contains("btn-remove")) {
                const id = parseInt(e.target.dataset.id);
                await fetch("/Staff/Cart/Api?handler=Remove", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id })
                });
              }
            });

            connection.on("CartUpdated", async (data) => {
              if (typeof data === "number") {
                const res = await fetch("/Staff/Cart/Api?handler=Items");
                data = await res.json();
              }
              renderCart(data);
            });

            // Cập nhật lại giao diện
            function renderCart(data){
              const container = document.getElementById('cart-container');
              if(!data.items || data.items.length===0){
                container.innerHTML = `
                  <div class="alert alert-info">Giỏ hàng đang trống.</div>
                  <a class="btn btn-outline-primary" href="/Staff/Vehicles/Index">Tiếp tục chọn xe</a>`;
                return;
              }
              const tbody   = document.getElementById('cart-body');
              const totalEl = document.getElementById('cart-total');
              const tpl     = document.getElementById('cart-row-tpl').content;

              tbody.innerHTML = '';
              data.items.forEach(it=>{
                const id        = it.id ?? it.electricVehicleId;
                const name      = it.name ?? it.model ?? '';
                const unit      = it.unitPrice ?? it.price ?? 0;
                const qty       = it.qty ?? it.quantity ?? 1;
                const line      = it.lineTotal ?? (unit * qty);
                const img       = it.imageUrl ?? '';
                const color     = it.color ?? '';

                const row = document.importNode(tpl, true);
                row.querySelector('tr').dataset.id = id;
                row.querySelector('.cart-name').textContent = name;
                const imgEl = row.querySelector('.cart-img');
                if(img){ imgEl.src = img; } else { imgEl.style.display='none'; }
                const colorWrap = row.querySelector('.cart-color');
                if(color){ colorWrap.style.display=''; colorWrap.querySelector('span').textContent = color; }

                row.querySelector('.cart-unit').textContent   = unit.toLocaleString('vi-VN');
                row.querySelector('.qty-input').value         = qty;
                row.querySelector('.qty-input').dataset.id    = id;
                row.querySelector('.line-total').textContent  = line.toLocaleString('vi-VN');
                row.querySelector('.btn-remove').dataset.id   = id;

                tbody.appendChild(row);
              });
              totalEl.textContent = (data.total ?? 0).toLocaleString('vi-VN');
            }

        })();
    </script>
}

<template id="cart-row-tpl">
    <tr data-id="">
        <td>
            <div class="d-flex align-items-center">
                <img class="me-2 cart-img" src="" alt=""
                     style="width:60px;height:40px;object-fit:cover" onerror="this.style.display='none'">
                <div>
                    <div class="fw-semibold cart-name"></div>
                    <div class="text-muted small cart-color" style="display:none">Màu: <span></span></div>
                </div>
            </div>
        </td>
        <td class="cart-unit"></td>
        <td>
            <input class="form-control qty-input" type="number" min="1" value="" data-id="">
        </td>
        <td class="line-total fw-bold"></td>
        <td class="text-end">
            <button class="btn btn-sm btn-outline-danger btn-remove" data-id="">Xóa</button>
        </td>
    </tr>
</template>

